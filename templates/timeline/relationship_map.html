{% extends 'timeline/base.html' %}
{% load static %}

{% block title %}Relationship Map - Story Timeline Builder{% endblock %}

{% block extra_css %}
<style>
    #relationship-network {
        width: 100%;
        height: 600px;
        background-color: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
    }

    .map-controls {
        background: #fff;
        padding: 15px;
        border-radius: var(--radius);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-panel {
        background: #fff;
        padding: 20px;
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        height: 600px;
        overflow-y: auto;
    }

    .legend {
        font-size: 0.85rem;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-diagram-3"></i> Relationship Map</h1>
    <div>
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#relationshipModal"
            id="btn-quick-add">
            <i class="bi bi-plus-circle"></i> Quick Link
        </button>
        <a href="{% url 'relationship_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> Manage
        </a>
    </div>
</div>

<div class="map-controls shadow-sm">
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #6366f1;"></div> Protagonist
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div> Antagonist
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #10b981;"></div> Ally
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f43f5e;"></div> Romantic
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #b91c1c;"></div> Enemy
        </div>
    </div>
    <div class="text-muted small">
        <i class="bi bi-info-circle"></i> <b>Tip:</b> Click a relationship line (edge) to edit the connection.
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-9">
        <div id="relationship-network"></div>
    </div>
    <div class="col-lg-3">
        <div class="info-panel shadow-sm" id="selection-details">
            <div class="text-center text-muted py-5">
                <i class="bi bi-cursor-fill fs-1 d-block mb-3"></i>
                <p>Click a character node or relationship line for details</p>
            </div>
        </div>
    </div>
</div>

<!-- Relationship Edit/Create Modal -->
<div class="modal fade" id="relationshipModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="relModalTitle">Manage Relationship</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="relationship-form">
                    {% csrf_token %}
                    <input type="hidden" name="id" id="rel-id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Character A</label>
                            <select name="character_a" id="rel-char-a" class="form-select" required>
                                {% for char in characters %}
                                <option value="{{ char.id }}">{{ char.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Character B</label>
                            <select name="character_b" id="rel-char-b" class="form-select" required>
                                {% for char in characters %}
                                <option value="{{ char.id }}">{{ char.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- AI Auto-Detect Button -->
                    <div class="mb-3 text-end">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-ask-ai"
                            title="Analyze shared scenes to suggest relationship">
                            <i class="bi bi-magic"></i> Auto-Detect with AI
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Type</label>
                        <select name="relationship_type" id="rel-type" class="form-select">
                            <option value="friend">Friend</option>
                            <option value="ally">Ally</option>
                            <option value="enemy">Enemy</option>
                            <option value="romantic">Romantic</option>
                            <option value="family">Family</option>
                            <option value="professional">Professional</option>
                            <option value="rival">Rival</option>
                            <option value="mentor">Mentor</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Description</label>
                        <textarea name="description" id="rel-desc" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Strength (1-10)</label>
                        <input type="range" name="strength" id="rel-strength" class="form-range" min="1" max="10"
                            step="1">
                        <div class="text-center small text-muted" id="strength-val">5</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-sm btn-outline-danger me-auto" id="btn-rel-delete"
                    style="display:none;">Delete</button>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-sm btn-dark" id="btn-rel-save">Save changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Vis.js via CDN -->
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('relationship-network');
        const detailsPanel = document.getElementById('selection-details');

        // Fetch data from API
        fetch('{% url "api_relationship_data" %}')
            .then(response => response.json())
            .then(data => {
                if (data.nodes.length === 0) {
                    container.innerHTML = `
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-people fs-1 mb-3"></i>
                            <p>No characters found to map.</p>
                            <a href="{% url 'character_create' %}" class="btn btn-sm btn-dark">Create Character</a>
                        </div>
                    `;
                    return;
                }

                const options = {
                    nodes: {
                        shape: 'dot',
                        size: 25,
                        font: {
                            size: 14,
                            color: '#1f2937'
                        },
                        borderWidth: 2,
                        shadow: true
                    },
                    edges: {
                        width: 2,
                        color: { inherit: 'from' },
                        smooth: {
                            type: 'continuous'
                        },
                        font: {
                            size: 10,
                            align: 'middle'
                        },
                        arrows: {
                            to: { enabled: true, scaleFactor: 0.5 }
                        }
                    },
                    physics: {
                        stabilization: true,
                        barnesHut: {
                            gravitationalConstant: -2000,
                            springLength: 200
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 200
                    }
                };

                const network = new vis.Network(container, data, options);

                const relModal = new bootstrap.Modal(document.getElementById('relationshipModal'));
                const relModalTitle = document.getElementById('relModalTitle');
                const relForm = document.getElementById('relationship-form');
                const relIdInput = document.getElementById('rel-id');
                const relCharA = document.getElementById('rel-char-a');
                const relCharB = document.getElementById('rel-char-b');
                const relType = document.getElementById('rel-type');
                const relDesc = document.getElementById('rel-desc');
                const relStrength = document.getElementById('rel-strength');
                const strengthVal = document.getElementById('strength-val');
                const btnSave = document.getElementById('btn-rel-save');
                const btnDelete = document.getElementById('btn-rel-delete');
                const btnQuickAdd = document.getElementById('btn-quick-add');
                const btnAskAi = document.getElementById('btn-ask-ai');

                // AI Auto-Detect Handler
                btnAskAi.onclick = function () {
                    const charA = relCharA.value;
                    const charB = relCharB.value;

                    if (!charA || !charB) {
                        alert("Please select both characters first.");
                        return;
                    }

                    if (charA === charB) {
                        alert("Characters must be different.");
                        return;
                    }

                    // Show loading state
                    const originalText = btnAskAi.innerHTML;
                    btnAskAi.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Scannning shared scenes...';
                    btnAskAi.disabled = true;

                    fetch('{% url "api_suggest_relationship" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            character_a: charA,
                            character_b: charB
                        })
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.status === 'success') {
                                const suggestion = result.suggestion;

                                // Map AI type to select options roughly
                                // Our types: friend, ally, enemy, romantic, family, professional, rival, mentor
                                // AI types: ally, enemy, romantic, family, mentor, business, neutral
                                let mappedType = 'neutral';
                                const aiType = suggestion.type.toLowerCase();

                                if (aiType.includes('romantic')) mappedType = 'romantic';
                                else if (aiType.includes('fam')) mappedType = 'family';
                                else if (aiType.includes('enem') || aiType.includes('rival')) mappedType = 'enemy';
                                else if (aiType.includes('business')) mappedType = 'professional';
                                else if (aiType.includes('mentor')) mappedType = 'mentor';
                                else if (aiType.includes('ally') || aiType.includes('friend')) mappedType = 'friend';

                                relType.value = mappedType;
                                relDesc.value = suggestion.description;
                                relStrength.value = suggestion.strength;
                                strengthVal.innerText = suggestion.strength;

                                // Visual feedback
                                btnAskAi.classList.remove('btn-outline-primary');
                                btnAskAi.classList.add('btn-success');
                                setTimeout(() => {
                                    btnAskAi.classList.remove('btn-success');
                                    btnAskAi.classList.add('btn-outline-primary');
                                }, 1500);
                            } else {
                                alert("AI Error: " + (result.message || "Unknown error"));
                            }
                        })
                        .catch(e => {
                            console.error(e);
                            alert("Failed to connect to AI.");
                        })
                        .finally(() => {
                            btnAskAi.innerHTML = originalText;
                            btnAskAi.disabled = false;
                        });
                };

                // Update strength value display
                relStrength.oninput = function () {
                    strengthVal.innerText = this.value;
                }

                function openModal(relData = null) {
                    relForm.reset();
                    if (relData) {
                        relModalTitle.innerText = "Edit Relationship";
                        relIdInput.value = relData.id;
                        relCharA.value = relData.from;
                        relCharB.value = relData.to;
                        relType.value = relData.type_key || 'friend'; // fallback
                        relDesc.value = relData.title || "";
                        relStrength.value = relData.strength || 5;
                        strengthVal.innerText = relStrength.value;
                        btnDelete.style.display = 'block';
                    } else {
                        relModalTitle.innerText = "New Relationship";
                        relIdInput.value = "";
                        btnDelete.style.display = 'none';
                        strengthVal.innerText = "5";
                    }
                    relModal.show();
                }

                btnQuickAdd.onclick = () => openModal();

                // Handle clicks for details and editing
                network.on("click", function (params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        const char = data.nodes.find(n => n.id === nodeId);
                        detailsPanel.innerHTML = `
                            <h4 class="mb-3">${char.label}</h4>
                            <div class="mb-3">
                                <span class="badge" style="background-color: ${char.color}">
                                    Character
                                </span>
                            </div>
                            <p class="text-muted small">${char.description || 'No description available.'}</p>
                            <hr>
                            <h6>Connections</h6>
                            <ul class="list-unstyled small">
                                ${data.edges.filter(e => e.from === nodeId || e.to === nodeId).map(e => {
                            const otherId = e.from === nodeId ? e.to : e.from;
                            const otherChar = data.nodes.find(n => n.id === otherId);
                            return `<li class="mb-2">â€¢ <strong>${e.label}</strong> with ${otherChar.label}</li>`;
                        }).join('') || 'None identified.'}
                            </ul>
                            <div class="mt-4">
                                <a href="/characters/${nodeId}/edit/" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-pencil"></i> Full Profile
                                </a>
                            </div>
                        `;
                    } else if (params.edges.length > 0) {
                        const edgeId = params.edges[0];
                        const edge = data.edges.find(e => e.id === edgeId);

                        detailsPanel.innerHTML = `
                            <h6>Relationship Edit</h6>
                            <div class="mb-3 p-3 bg-light rounded border text-center">
                                <div class="fw-bold mb-1">${edge.label}</div>
                                <div class="small text-muted">Click below to manage this connection</div>
                            </div>
                            <button class="btn btn-sm btn-dark w-100" id="btn-edit-active-edge">
                                <i class="bi bi-pencil-square"></i> Open Editor
                            </button>
                        `;

                        document.getElementById('btn-edit-active-edge').onclick = function () {
                            // Map the edge type back to keys (approximation if not precise in API)
                            const type_key = edge.label.toLowerCase();
                            openModal({ ...edge, type_key: type_key, strength: edge.width * 2 });
                        };
                    } else {
                        detailsPanel.innerHTML = `
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-cursor-fill fs-1 d-block mb-3"></i>
                                <p>Click a character node or relationship line for details</p>
                            </div>
                        `;
                    }
                });

                // AJAX Save
                btnSave.onclick = function () {
                    const formData = {
                        id: relIdInput.value,
                        character_a: relCharA.value,
                        character_b: relCharB.value,
                        relationship_type: relType.value,
                        description: relDesc.value,
                        strength: relStrength.value,
                        action: 'save'
                    };

                    btnSave.disabled = true;
                    fetch('{% url "api_manage_relationship" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(formData)
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.status === 'success') {
                                location.reload(); // Quickest way to refresh the complex map
                            } else {
                                alert("Error: " + JSON.stringify(result.errors || result.message));
                                btnSave.disabled = false;
                            }
                        })
                        .catch(e => {
                            console.error(e);
                            btnSave.disabled = false;
                        });
                };

                // AJAX Delete
                btnDelete.onclick = function () {
                    if (!confirm("Are you sure you want to remove this connection?")) return;

                    const formData = {
                        id: relIdInput.value,
                        action: 'delete'
                    };

                    fetch('{% url "api_manage_relationship" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(formData)
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.status === 'success') {
                                location.reload();
                            }
                        });
                };
            })
            .catch(error => {
                console.error('Error fetching relationship data:', error);
                container.innerHTML = '<div class="alert alert-danger m-3">Failed to load relationship data.</div>';
            });
    });
</script>
{% endblock %}