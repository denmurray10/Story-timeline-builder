{% extends 'timeline/base.html' %}
{% load static %}

{% block title %}Relationship Map - Story Timeline Builder{% endblock %}

{% block extra_css %}
<style>
    #relationship-network {
        width: 100%;
        height: 600px;
        background-color: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
    }

    .map-controls {
        background: #fff;
        padding: 15px;
        border-radius: var(--radius);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .info-panel {
        background: #fff;
        padding: 20px;
        border-radius: var(--radius);
        border: 1px solid var(--border-color);
        height: 600px;
        overflow-y: auto;
    }

    .btn-profile-style {
        color: #555;
        font-weight: 600;
        background: #f4f1ee;
        border: none;
        transition: all 0.2s;
        font-size: 0.85rem;
        border-radius: 999px;
    }

    .btn-profile-style:hover {
        background: #e9e6e3;
        color: #111;
    }

    /* Professional Form Styling */
    .overlay-content {
        max-width: 650px;
        margin: 0 auto;
    }

    .form-section-header {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.05rem;
        color: #6b7280;
        margin-bottom: 1.25rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f1f5f9;
    }

    .overlay-form-card {
        background: #fdfdfd;
        border: 1px solid #f1f5f9;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .form-label-pro {
        font-size: 0.85rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.4rem;
    }

    .form-control-pro,
    .form-select-pro {
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        padding: 0.6rem 0.8rem;
        font-size: 0.9rem;
        background-color: #ffffff;
    }

    .form-control-pro:focus,
    .form-select-pro:focus {
        border-color: #111;
        box-shadow: none;
    }

    .legend {
        font-size: 0.85rem;
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    /* Filter Bar Area */
    .filter-bar {
        background: #f8fafc;
        padding: 12px 18px;
        border-radius: var(--radius);
        margin-bottom: 20px;
        border: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
    }

    .filter-pill {
        padding: 4px 12px;
        border-radius: 999px;
        background: #fff;
        border: 1px solid #cbd5e1;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .filter-pill:hover {
        border-color: #64748b;
        background: #f1f5f9;
    }

    .filter-pill.active {
        background: #1e293b;
        color: #fff;
        border-color: #1e293b;
    }

    .filter-pill.active .pill-icon {
        color: #94a3b8;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="bi bi-diagram-3"></i> Relationship Map</h1>
    <div>
        <button type="button" class="btn btn-dark" data-bs-toggle="modal" data-bs-target="#relationshipModal"
            id="btn-quick-add">
            <i class="bi bi-plus-circle"></i> Quick Link
        </button>
        <a href="{% url 'relationship_list' %}" class="btn btn-outline-secondary">
            <i class="bi bi-list"></i> Manage
        </a>
    </div>
</div>

<div class="map-controls shadow-sm">
    <div class="legend">
        <div class="legend-item">
            <div class="legend-color" style="background: #6366f1;"></div> Protagonist
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ef4444;"></div> Antagonist
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #3b82f6;"></div> Friend
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #10b981;"></div> Ally
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f43f5e;"></div> Romantic
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #8b5cf6;"></div> Family
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #eab308;"></div> Mentor
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f97316;"></div> Rival
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #b91c1c;"></div> Enemy
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #64748b;"></div> Pro
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #9ca3af;"></div> Neutral
        </div>
    </div>
    <div class="text-muted small">
        <i class="bi bi-info-circle"></i> <b>Tip:</b> Click a relationship line (edge) to edit the connection.
    </div>
</div>

<div class="filter-bar shadow-sm">
    <span class="text-muted small fw-bold text-uppercase me-2"><i class="bi bi-filter"></i> Filter:</span>
    <div id="filter-pills" class="d-flex flex-wrap gap-2">
        <!-- JS will populate these -->
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-9">
        <div class="position-relative" style="height: 600px; border-radius: 12px; overflow: hidden;">
            <div id="relationship-network" style="height: 100%;"></div>

            <!-- Overlay Modal -->
            <div id="relationship-overlay" class="position-absolute top-0 start-0 w-100 h-100 bg-white"
                style="z-index: 10; display: none; overflow-y: auto;">
                <div class="p-4 p-md-5 container-fluid">
                    <div class="overlay-content">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h4 class="mb-1 fw-bold" id="overlayTitle">Relationship Detail</h4>
                                <p class="small text-muted mb-0">Refine the connection between your characters.</p>
                            </div>
                            <button type="button" class="btn-close shadow-none" id="btn-close-overlay"></button>
                        </div>

                        <form id="relationship-form">
                            {% csrf_token %}
                            <input type="hidden" name="id" id="rel-id">

                            <!-- Characters Header Section -->
                            <div id="section-header-characters" class="overlay-form-card mb-4 bg-light border-0">
                                <div class="row g-3 align-items-center">
                                    <div class="col-md-5">
                                        <label class="form-label-pro">Character A</label>
                                        <select name="character_a" id="rel-char-a" class="form-select form-select-pro"
                                            required>
                                            {% for char in characters %}
                                            <option value="{{ char.id }}">{{ char.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2 text-center pt-4">
                                        <i class="bi bi-arrow-left-right text-muted opacity-50"></i>
                                    </div>
                                    <div class="col-md-5">
                                        <label class="form-label-pro">Character B</label>
                                        <select name="character_b" id="rel-char-b" class="form-select form-select-pro"
                                            required>
                                            {% for char in characters %}
                                            <option value="{{ char.id }}">{{ char.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Sections (Visible logic handled via JS) -->

                            <!-- Core Section -->
                            <div id="section-core" class="form-section">
                                <h6 class="form-section-header"><i class="bi bi-heart me-2"></i> Core Stats</h6>
                                <div class="overlay-form-card">
                                    <div class="mb-4">
                                        <label class="form-label-pro">Relationship Type</label>
                                        <div class="input-group">
                                            <select name="relationship_type" id="rel-type"
                                                class="form-select form-select-pro" required>
                                                <option value="friend">Friend</option>
                                                <option value="ally">Ally</option>
                                                <option value="enemy">Enemy</option>
                                                <option value="romantic">Romantic</option>
                                                <option value="family">Family</option>
                                                <option value="mentor">Mentor</option>
                                                <option value="rival">Rival</option>
                                                <option value="professional">Professional</option>
                                                <option value="neutral">Neutral</option>
                                            </select>
                                            <button type="button" class="btn btn-dark px-3" id="btn-ask-ai"
                                                title="Auto-detect from story">
                                                <i class="bi bi-magic me-2"></i> Analyze with AI
                                            </button>
                                        </div>
                                    </div>

                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <label class="form-label-pro">Current Status</label>
                                            <select id="rel-status" class="form-select form-select-pro">
                                                <option value="active">Active Connection</option>
                                                <option value="estranged">Estranged / Rifts</option>
                                                <option value="deceased">Ended (Death)</option>
                                                <option value="unresolved">Unresolved / Tense</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label-pro">Visibility</label>
                                            <select id="rel-visibility" class="form-select form-select-pro">
                                                <option value="public">Publicly Known</option>
                                                <option value="secret">Strictly Secret</option>
                                                <option value="rumored">Rumored Info</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between">
                                            <label class="form-label-pro">Intensity / Strength</label>
                                            <span id="strength-val"
                                                class="badge bg-light text-dark border px-2 py-1">5</span>
                                        </div>
                                        <input type="range" class="form-range" min="1" max="10" id="rel-strength">
                                    </div>

                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between">
                                            <label class="form-label-pro">Trust Level</label>
                                            <span id="trust-val"
                                                class="badge bg-light text-dark border px-2 py-1">5</span>
                                        </div>
                                        <input type="range" class="form-range" min="1" max="10" id="rel-trust">
                                    </div>

                                    <div class="row g-3 mb-4">
                                        <div class="col-md-6">
                                            <label class="form-label-pro">First Impression</label>
                                            <textarea id="rel-first-impression" class="form-control form-control-pro"
                                                rows="2" placeholder="Initial perception..."></textarea>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label-pro">Shared Secret</label>
                                            <textarea id="rel-shared-secret" class="form-control form-control-pro"
                                                rows="2" placeholder="What only they know..."></textarea>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between">
                                            <label class="form-label-pro">Relationship Predictability</label>
                                            <span id="predictability-val"
                                                class="badge bg-light text-dark border px-2 py-1">5</span>
                                        </div>
                                        <input type="range" class="form-range" min="1" max="10" id="rel-predictability">
                                        <div class="d-flex justify-content-between small text-muted px-1">
                                            <span>Erratic</span>
                                            <span>Highly Intuitive</span>
                                        </div>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label-pro">Core Vulnerability</label>
                                        <textarea id="rel-vulnerability" class="form-control form-control-pro" rows="2"
                                            placeholder="What they hide or their mutual weakness..."></textarea>
                                    </div>

                                    <div class="mb-4">
                                        <label class="form-label-pro">Major Shared Moments</label>
                                        <textarea id="rel-moments" class="form-control form-control-pro" rows="2"
                                            placeholder="Summary of defining interactions..."></textarea>
                                    </div>

                                    <div class="mb-0">
                                        <label class="form-label-pro">General Description</label>
                                        <textarea id="rel-desc" class="form-control form-control-pro" rows="2"
                                            placeholder="Describe their history and current bond..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Dynamics Section -->
                            <div id="section-dynamics" class="form-section">
                                <h6 class="form-section-header"><i class="bi bi-lightning me-2"></i> Power & Dynamics
                                </h6>
                                <div class="overlay-form-card">
                                    <div class="mb-4">
                                        <label class="form-label-pro">Power Dynamic</label>
                                        <select id="rel-power" class="form-select form-select-pro">
                                            <option value="balanced">Perfectly Balanced</option>
                                            <option value="a_dominant">Character A is Dominant</option>
                                            <option value="b_dominant">Character B is Dominant</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="form-label-pro">Deep Source of Conflict</label>
                                        <textarea id="rel-conflict" class="form-control form-control-pro" rows="3"
                                            placeholder="What specifically creates friction between them?"></textarea>
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label-pro">Evolution over Time</label>
                                        <textarea id="rel-evolution" class="form-control form-control-pro" rows="3"
                                            placeholder="How has this connection changed through the book?"></textarea>
                                    </div>
                                </div>
                            </div>

                            <!-- Goals Section -->
                            <div id="section-goals" class="form-section">
                                <h6 class="form-section-header"><i class="bi bi-bullseye me-2"></i> Intentions & Goals
                                </h6>
                                <div class="overlay-form-card">
                                    <div class="mb-4">
                                        <label class="form-label-pro" id="label-a-wants">What Character A Wants from
                                            B</label>
                                        <textarea id="rel-a-wants" class="form-control form-control-pro" rows="4"
                                            placeholder="Their desires, demands, or needs regarding the other..."></textarea>
                                    </div>
                                    <div class="mb-0">
                                        <label class="form-label-pro" id="label-b-wants">What Character B Wants from
                                            A</label>
                                        <textarea id="rel-b-wants" class="form-control form-control-pro" rows="4"
                                            placeholder="Their desires, demands, or needs regarding the other..."></textarea>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-5">
                                <button type="button" class="btn btn-outline-danger btn-sm border-0" id="btn-rel-delete"
                                    style="display:none;">
                                    <i class="bi bi-trash me-1"></i> Delete Relationship
                                </button>
                                <div class="d-flex gap-2 ms-auto">
                                    <button type="button" class="btn btn-light px-4 py-2 rounded-pill fw-bold"
                                        id="btn-cancel-overlay">Cancel</button>
                                    <button type="button" class="btn btn-dark px-4 py-2 rounded-pill fw-bold"
                                        id="btn-rel-save">Save Changes</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-3">
        <div class="info-panel shadow-sm" id="selection-details">
            <div class="text-center text-muted py-5">
                <i class="bi bi-cursor-fill fs-1 d-block mb-3"></i>
                <p>Click a character node or relationship line for details</p>
            </div>
        </div>
    </div>
</div>

<!-- Relationship Edit/Create Modal -->
<div class="modal fade" id="relationshipModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title" id="relModalTitle">Manage Relationship</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="relationship-form">
                    {% csrf_token %}
                    <input type="hidden" name="id" id="rel-id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Character A</label>
                            <select name="character_a" id="rel-char-a" class="form-select" required>
                                {% for char in characters %}
                                <option value="{{ char.id }}">{{ char.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Character B</label>
                            <select name="character_b" id="rel-char-b" class="form-select" required>
                                {% for char in characters %}
                                <option value="{{ char.id }}">{{ char.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- AI Auto-Detect Button -->
                    <div class="mb-3 text-end">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="btn-ask-ai"
                            title="Analyze shared scenes to suggest relationship">
                            <i class="bi bi-magic"></i> Auto-Detect with AI
                        </button>
                    </div>

                    <!-- Tabs -->
                    <ul class="nav nav-tabs mb-3" id="relTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="core-tab" data-bs-toggle="tab" data-bs-target="#core"
                                type="button" role="tab">Core</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="dynamics-tab" data-bs-toggle="tab" data-bs-target="#dynamics"
                                type="button" role="tab">Dynamics</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="goals-tab" data-bs-toggle="tab" data-bs-target="#goals"
                                type="button" role="tab">Goals</button>
                        </li>
                    </ul>

                    <div class="tab-content" id="relTabsContent">
                        <!-- Tab 1: Core Details -->
                        <div class="tab-pane fade show active" id="core" role="tabpanel">
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">Type</label>
                                    <select name="relationship_type" id="rel-type" class="form-select">
                                        <option value="friend">Friend</option>
                                        <option value="ally">Ally</option>
                                        <option value="enemy">Enemy</option>
                                        <option value="romantic">Romantic</option>
                                        <option value="family">Family</option>
                                        <option value="professional">Professional</option>
                                        <option value="rival">Rival</option>
                                        <option value="mentor">Mentor</option>
                                        <option value="neutral">Neutral</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">Status</label>
                                    <select name="relationship_status" id="rel-status" class="form-select">
                                        <option value="active">Active</option>
                                        <option value="estranged">Estranged</option>
                                        <option value="deceased">Deceased</option>
                                        <option value="unresolved">Unresolved</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Visibility</label>
                                <select name="visibility" id="rel-visibility" class="form-select">
                                    <option value="public">Public Knowledge</option>
                                    <option value="secret">Secret</option>
                                    <option value="rumored">Rumored/Suspected</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold d-flex justify-content-between">
                                    <span>Strength (Intensity)</span> <span id="strength-val"
                                        class="text-muted">5</span>
                                </label>
                                <input type="range" name="strength" id="rel-strength" class="form-range" min="1"
                                    max="10" step="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold d-flex justify-content-between">
                                    <span>Trust Level</span> <span id="trust-val" class="text-muted">5</span>
                                </label>
                                <input type="range" name="trust_level" id="rel-trust" class="form-range" min="1"
                                    max="10" step="1">
                            </div>
                        </div>

                        <!-- Tab 2: Dynamics -->
                        <div class="tab-pane fade" id="dynamics" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Power Dynamic</label>
                                <select name="power_dynamic" id="rel-power" class="form-select">
                                    <option value="balanced">Balanced (=)</option>
                                    <option value="a_dominant">Char A Dominant (>)</option>
                                    <option value="b_dominant">Char B Dominant (<)< /option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Conflict Source</label>
                                <input type="text" name="conflict_source" id="rel-conflict" class="form-control"
                                    placeholder="What drives the tension?">
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Evolution Notes</label>
                                <textarea name="evolution" id="rel-evolution" class="form-control" rows="2"
                                    placeholder="e.g. Strangers -> Allies -> Rivals"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">Description</label>
                                <textarea name="description" id="rel-desc" class="form-control" rows="2"
                                    placeholder="Summary of their bond"></textarea>
                            </div>
                        </div>

                        <!-- Tab 3: Goals -->
                        <div class="tab-pane fade" id="goals" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label small fw-bold">What Character A Wants</label>
                                <textarea name="character_a_wants" id="rel-a-wants" class="form-control" rows="3"
                                    placeholder="Goals regarding Character B"></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small fw-bold">What Character B Wants</label>
                                <textarea name="character_b_wants" id="rel-b-wants" class="form-control" rows="3"
                                    placeholder="Goals regarding Character A"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-sm btn-outline-danger me-auto" id="btn-rel-delete"
                    style="display:none;">Delete</button>
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-sm btn-dark" id="btn-rel-save">Save changes</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Vis.js via CDN -->
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('relationship-network');
        const detailsPanel = document.getElementById('selection-details');

        // Fetch data from API
        fetch('{% url "api_relationship_data" %}')
            .then(response => response.json())
            .then(data => {
                if (data.nodes.length === 0) {
                    container.innerHTML = `
                        <div class="d-flex flex-column align-items-center justify-content-center h-100 text-muted">
                            <i class="bi bi-people fs-1 mb-3"></i>
                            <p>No characters found to map.</p>
                            <a href="{% url 'character_create' %}" class="btn btn-sm btn-dark">Create Character</a>
                        </div>
                    `;
                    return;
                }

                const options = {
                    nodes: {
                        shape: 'dot',
                        size: 25,
                        font: {
                            size: 14,
                            color: '#1f2937'
                        },
                        borderWidth: 2,
                        shadow: true
                    },
                    edges: {
                        width: 2,
                        color: { inherit: 'from' },
                        smooth: {
                            type: 'continuous'
                        },
                        font: {
                            size: 10,
                            align: 'middle'
                        },
                        arrows: {
                            to: { enabled: true, scaleFactor: 0.5 }
                        }
                    },
                    physics: {
                        stabilization: true,
                        barnesHut: {
                            gravitationalConstant: -2000,
                            springLength: 200
                        }
                    },
                    interaction: {
                        hover: true,
                        tooltipDelay: 200
                    }
                };

                const network = new vis.Network(container, data, options);

                // --- FILTER LOGIC ---
                const filterPillsContainer = document.getElementById('filter-pills');
                let activeFilters = new Set();

                // Store original sets for quick reference
                const originalNodes = JSON.parse(JSON.stringify(data.nodes));
                const originalEdges = JSON.parse(JSON.stringify(data.edges));

                function populateFilterPills() {
                    filterPillsContainer.innerHTML = '';
                    originalNodes.sort((a, b) => a.label.localeCompare(b.label)).forEach(node => {
                        const pill = document.createElement('div');
                        pill.className = 'filter-pill';
                        pill.innerHTML = `<span class="pill-icon"><i class="bi bi-person"></i></span> ${node.label}`;
                        pill.dataset.id = node.id;
                        pill.onclick = () => toggleFilter(node.id);
                        filterPillsContainer.appendChild(pill);
                    });
                }

                function applyFilter() {
                    if (activeFilters.size === 0) {
                        network.setData({ nodes: originalNodes, edges: originalEdges });
                    } else {
                        // Filter nodes: include explicitly selected nodes
                        // or nodes connected to selected nodes (to show their relationships)
                        const filteredNodes = originalNodes.filter(n => {
                            const isMatched = activeFilters.has(n.id);
                            // If we want to show ONLY connections between selected, stop here.
                            // But usually, if I select "Leo", I want to see Leo and everyone he connects to.
                            if (isMatched) return true;

                            // Check if this node is connected to any active filter node
                            return originalEdges.some(e =>
                                (e.from === n.id && activeFilters.has(e.to)) ||
                                (e.to === n.id && activeFilters.has(e.from))
                            );
                        });

                        // Filter edges: must have at least one end in the active filters
                        const filteredEdges = originalEdges.filter(e =>
                            activeFilters.has(e.from) || activeFilters.has(e.to)
                        );

                        network.setData({ nodes: filteredNodes, edges: filteredEdges });
                    }

                    // Update Pill UI
                    const pills = filterPillsContainer.querySelectorAll('.filter-pill');
                    pills.forEach(p => {
                        if (activeFilters.has(parseInt(p.dataset.id))) {
                            p.classList.add('active');
                        } else {
                            p.classList.remove('active');
                        }
                    });
                }

                function toggleFilter(nodeId) {
                    const id = parseInt(nodeId);
                    if (activeFilters.has(id)) {
                        activeFilters.delete(id);
                    } else {
                        activeFilters.add(id);
                    }
                    applyFilter();
                }

                // Initial build
                populateFilterPills();

                // const relModal = new bootstrap.Modal(document.getElementById('relationshipModal')); // Removed
                const overlay = document.getElementById('relationship-overlay');
                const overlayTitle = document.getElementById('overlayTitle');
                const relForm = document.getElementById('relationship-form');
                const relIdInput = document.getElementById('rel-id');
                const relCharA = document.getElementById('rel-char-a');
                const relCharB = document.getElementById('rel-char-b');
                const relType = document.getElementById('rel-type');
                const relStatus = document.getElementById('rel-status');
                const relVisibility = document.getElementById('rel-visibility');
                const relDesc = document.getElementById('rel-desc');
                const relStrength = document.getElementById('rel-strength');
                const strengthVal = document.getElementById('strength-val');
                const relTrust = document.getElementById('rel-trust');
                const trustVal = document.getElementById('trust-val');
                const relPower = document.getElementById('rel-power');
                const relConflict = document.getElementById('rel-conflict');
                const relEvolution = document.getElementById('rel-evolution');
                const relAWants = document.getElementById('rel-a-wants');
                const relBWants = document.getElementById('rel-b-wants');
                const relSharedSecret = document.getElementById('rel-shared-secret');
                const relFirstImpression = document.getElementById('rel-first-impression');
                const relVulnerability = document.getElementById('rel-vulnerability');
                const relMoments = document.getElementById('rel-moments');
                const relPredictability = document.getElementById('rel-predictability');
                const predictabilityVal = document.getElementById('predictability-val');
                const btnSave = document.getElementById('btn-rel-save');
                const btnDelete = document.getElementById('btn-rel-delete');
                const btnQuickAdd = document.getElementById('btn-quick-add');
                const btnAskAi = document.getElementById('btn-ask-ai');
                const btnCloseOverlay = document.getElementById('btn-close-overlay');
                const btnCancelOverlay = document.getElementById('btn-cancel-overlay');

                // Overlay Toggle Logic
                function openModal(data = null, section = 'core') {
                    // Hide all sections first
                    document.querySelectorAll('.form-section').forEach(s => s.style.display = 'none');

                    // Show the requested section
                    const targetSection = document.getElementById(`section-${section}`);
                    if (targetSection) targetSection.style.display = 'block';

                    const charHeader = document.getElementById('section-header-characters');
                    const overlaySub = overlay.querySelector('p.text-muted');

                    function updateLabels() {
                        const nameA = relCharA.options[relCharA.selectedIndex]?.text || "Character A";
                        const nameB = relCharB.options[relCharB.selectedIndex]?.text || "Character B";
                        document.getElementById('label-a-wants').innerText = `What ${nameA} Wants from ${nameB}`;
                        document.getElementById('label-b-wants').innerText = `What ${nameB} Wants from ${nameA}`;

                        if (data) {
                            overlaySub.innerHTML = `Relating <strong>${nameA}</strong> and <strong>${nameB}</strong>`;
                        } else {
                            overlaySub.innerText = "Refine the connection between your characters.";
                        }
                    }

                    if (data) {
                        relIdInput.value = data.id;
                        relCharA.value = data.from;
                        relCharB.value = data.to;

                        // Hide character selector if editing specific relationship
                        if (charHeader) charHeader.style.display = 'none';

                        // Handle type key mapping
                        let typeVal = data.type_key || 'neutral';
                        if (![...relType.options].some(o => o.value === typeVal)) {
                            // Try to find by text if key doesn't match
                            const found = [...relType.options].find(o => o.text.toLowerCase() === data.label.toLowerCase());
                            if (found) typeVal = found.value;
                        }
                        relType.value = typeVal;

                        relDesc.value = data.title || '';
                        relStrength.value = data.strength || 5;
                        strengthVal.innerText = data.strength || 5;
                        relTrust.value = data.trust_level || 5;
                        trustVal.innerText = data.trust_level || 5;
                        relStatus.value = data.status || 'active';
                        relVisibility.value = data.visibility || 'public';
                        relPower.value = data.power_dynamic || 'balanced';
                        relConflict.value = data.conflict_source || '';
                        relEvolution.value = data.evolution || '';
                        relAWants.value = data.character_a_wants || '';
                        relBWants.value = data.character_b_wants || '';
                        relFirstImpression.value = data.first_impression || '';
                        relSharedSecret.value = data.shared_secret || '';
                        relVulnerability.value = data.vulnerability || '';
                        relMoments.value = data.major_shared_moments || '';
                        relPredictability.value = data.predictability || 5;
                        predictabilityVal.innerText = data.predictability || 5;

                        overlayTitle.innerText = "Edit Relationship";
                        btnDelete.style.display = 'block';
                    } else {
                        relIdInput.value = "";
                        relForm.reset();
                        strengthVal.innerText = "5";
                        trustVal.innerText = "5";
                        predictabilityVal.innerText = "5";
                        overlayTitle.innerText = "New Relationship";
                        btnDelete.style.display = 'none';

                        // Show character selector for new relationship
                        if (charHeader) charHeader.style.display = 'block';
                    }

                    updateLabels();
                    relCharA.onchange = updateLabels;
                    relCharB.onchange = updateLabels;

                    // Show Overlay
                    overlay.style.display = 'block';
                }

                function closeOverlay() {
                    overlay.style.display = 'none';
                }

                btnQuickAdd.onclick = () => openModal();
                btnCloseOverlay.onclick = closeOverlay;
                btnCancelOverlay.onclick = closeOverlay;

                // AI Auto-Detect Handler
                btnAskAi.onclick = function () {
                    const charA = relCharA.value;
                    const charB = relCharB.value;

                    if (!charA || !charB) {
                        alert("Please select both characters first.");
                        return;
                    }

                    if (charA === charB) {
                        alert("Characters must be different.");
                        return;
                    }

                    // Show loading state
                    const originalText = btnAskAi.innerHTML;
                    btnAskAi.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Scannning shared scenes...';
                    btnAskAi.disabled = true;

                    fetch('{% url "api_suggest_relationship" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            character_a: charA,
                            character_b: charB
                        })
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.status === 'success') {
                                const suggestion = result.suggestion;

                                // Map AI type to select options roughly
                                // Our types: friend, ally, enemy, romantic, family, professional, rival, mentor
                                // AI types: ally, enemy, romantic, family, mentor, business, neutral
                                let mappedType = 'neutral';
                                const aiType = suggestion.type.toLowerCase();

                                if (aiType.includes('romantic')) mappedType = 'romantic';
                                else if (aiType.includes('fam')) mappedType = 'family';
                                else if (aiType.includes('enem') || aiType.includes('rival')) mappedType = 'enemy';
                                else if (aiType.includes('business')) mappedType = 'professional';
                                else if (aiType.includes('mentor')) mappedType = 'mentor';
                                else if (aiType.includes('ally') || aiType.includes('friend')) mappedType = 'friend';

                                relType.value = mappedType;
                                relDesc.value = suggestion.description;
                                relStrength.value = suggestion.strength;
                                strengthVal.innerText = suggestion.strength;

                                // New fields
                                if (suggestion.trust_level) {
                                    relTrust.value = suggestion.trust_level;
                                    trustVal.innerText = suggestion.trust_level;
                                }
                                if (suggestion.power_dynamic) relPower.value = suggestion.power_dynamic;
                                if (suggestion.relationship_status) relStatus.value = suggestion.relationship_status;
                                if (suggestion.visibility) relVisibility.value = suggestion.visibility;
                                if (suggestion.conflict_source) relConflict.value = suggestion.conflict_source;
                                if (suggestion.character_a_wants) relAWants.value = suggestion.character_a_wants;
                                if (suggestion.character_b_wants) relBWants.value = suggestion.character_b_wants;
                                if (suggestion.evolution) relEvolution.value = suggestion.evolution;
                                if (suggestion.shared_secret) relSharedSecret.value = suggestion.shared_secret;
                                if (suggestion.first_impression) relFirstImpression.value = suggestion.first_impression;
                                if (suggestion.vulnerability) relVulnerability.value = suggestion.vulnerability;
                                if (suggestion.major_shared_moments) relMoments.value = suggestion.major_shared_moments;
                                if (suggestion.predictability) {
                                    relPredictability.value = suggestion.predictability;
                                    predictabilityVal.innerText = suggestion.predictability;
                                }

                                // Visual feedback
                                btnAskAi.classList.remove('btn-outline-primary');
                                btnAskAi.classList.add('btn-success');
                                setTimeout(() => {
                                    btnAskAi.classList.remove('btn-success');
                                    btnAskAi.classList.add('btn-outline-primary');
                                }, 1500);
                            } else {
                                alert("AI Error: " + (result.message || "Unknown error"));
                            }
                        })
                        .catch(e => {
                            console.error(e);
                            alert("Failed to connect to AI.");
                        })
                        .finally(() => {
                            btnAskAi.innerHTML = originalText;
                            btnAskAi.disabled = false;
                        });
                };

                // Update slider displays
                relStrength.oninput = function () { strengthVal.innerText = this.value; }
                relTrust.oninput = function () { trustVal.innerText = this.value; }
                relPredictability.oninput = function () { predictabilityVal.innerText = this.value; }

                btnQuickAdd.onclick = () => openModal();

                // Handle clicks for details and editing
                network.on("click", function (params) {
                    if (params.nodes.length > 0) {
                        const nodeId = params.nodes[0];
                        const char = data.nodes.find(n => n.id === nodeId);
                        detailsPanel.innerHTML = `
                            <h4 class="mb-3">${char.label}</h4>
                            <div class="mb-3">
                                <span class="badge" style="background-color: ${char.color}">
                                    Character
                                </span>
                            </div>
                            <p class="text-muted small">${char.description || 'No description available.'}</p>
                            <hr>
                            <h6>Connections</h6>
                            <ul class="list-unstyled small">
                                ${data.edges.filter(e => e.from === nodeId || e.to === nodeId).map(e => {
                            const otherId = e.from === nodeId ? e.to : e.from;
                            const otherChar = data.nodes.find(n => n.id === otherId);
                            return `<li class="mb-2"> <strong>${e.label}</strong> with ${otherChar.label}</li>`;
                        }).join('') || 'None identified.'}
                            </ul>
                            <div class="mt-4">
                                <a href="/characters/${nodeId}/edit/" class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-pencil"></i> Full Profile
                                </a>
                            </div>
                        `;
                    } else if (params.edges.length > 0) {
                        const edgeId = params.edges[0];
                        const edge = data.edges.find(e => e.id === edgeId);
                        const charA = data.nodes.find(n => n.id === edge.from);
                        const charB = data.nodes.find(n => n.id === edge.to);

                        // Profile-style layout
                        detailsPanel.innerHTML = `
                            <div class="card border-0 shadow-none bg-transparent">
                                <div class="card-body p-0 text-center">
                                    <!-- Overlapping Avatars -->
                                    <div class="d-flex justify-content-center align-items-center mb-3 position-relative" style="height: 80px;">
                                        <div class="position-absolute start-50 translate-middle-x" style="margin-left: -25px; z-index: 1;">
                                            ${charA.profile_pic_url ?
                                `<img src="${charA.profile_pic_url}" class="rounded-circle border border-2 border-white shadow-sm" style="width: 60px; height: 60px; object-fit: cover;">` :
                                `<div class="rounded-circle border border-2 border-white shadow-sm bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-person text-muted"></i></div>`
                            }
                                        </div>
                                        <div class="position-absolute start-50 translate-middle-x" style="margin-left: 25px; z-index: 2;">
                                            ${charB.profile_pic_url ?
                                `<img src="${charB.profile_pic_url}" class="rounded-circle border border-2 border-white shadow-sm" style="width: 60px; height: 60px; object-fit: cover;">` :
                                `<div class="rounded-circle border border-2 border-white shadow-sm bg-light d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;"><i class="bi bi-person text-muted"></i></div>`
                            }
                                        </div>
                                    </div>
                                    
                                    <h5 class="mb-1 fw-bold text-dark">${edge.label}</h5>
                                    <p class="small text-muted mb-3">
                                        Between <a href="/characters/${charA.id}/" class="text-decoration-none fw-bold text-dark">${charA.label}</a> 
                                        & <a href="/characters/${charB.id}/" class="text-decoration-none fw-bold text-dark">${charB.label}</a>
                                    </p>
                                    
                                    <div class="d-flex gap-2 justify-content-center mb-4">
                                        <span class="badge bg-light text-dark border">${edge.status || 'Active'}</span>
                                        <span class="badge bg-light text-dark border">${edge.visibility || 'Public'}</span>
                                        <span class="badge bg-dark text-white border">${edge.strength}/10 Intensity</span>
                                    </div>

                                    <!-- Pill Navigation Buttons (Moved to Top) -->
                                    <div class="d-grid gap-2 mb-3">
                                        <button class="btn btn-profile-style rounded-pill py-2 d-flex align-items-center justify-content-center" 
                                            onclick="openModalForEdge(${edge.id}, 'core')">
                                            <i class="bi bi-heart me-2"></i> Edit Core Detail
                                        </button>
                                        <button class="btn btn-profile-style rounded-pill py-2 d-flex align-items-center justify-content-center" 
                                            onclick="openModalForEdge(${edge.id}, 'dynamics')">
                                            <i class="bi bi-lightning me-2"></i> Power Dynamics
                                        </button>
                                    </div>

                                    <!-- Narrative Arc (Moved up) -->
                                    <div class="text-start bg-light p-3 rounded-3 mb-3 border">
                                        <h6 class="small fw-bold text-uppercase text-muted mb-2">Narrative Arc</h6>
                                        <p class="small mb-0 text-break">${edge.evolution || edge.title || '<span class="text-muted fst-italic">No arc data yet.</span>'}</p>
                                    </div>

                                    <!-- Deep Intelligence Section (Colored Boxes) -->
                                    <div class="text-start mb-4">
                                        ${edge.shared_secret ? `
                                            <div class="bg-light-info p-2 rounded-3 mb-2" style="background-color: #f0f7ff; border: 1px solid #dbeafe;">
                                                <h6 class="small fw-bold text-info text-uppercase mb-1" style="font-size: 0.65rem;">Shared Secret</h6>
                                                <p class="small mb-0 fst-italic">"${edge.shared_secret}"</p>
                                            </div>
                                        ` : ''}
                                        ${edge.vulnerability ? `
                                            <div class="bg-light-warning p-2 rounded-3 mb-2" style="background-color: #fffaf0; border: 1px solid #fef3c7;">
                                                <h6 class="small fw-bold text-warning text-uppercase mb-1" style="font-size: 0.65rem;">Mutual Vulnerability</h6>
                                                <p class="small mb-0">"${edge.vulnerability}"</p>
                                            </div>
                                        ` : ''}
                                        ${edge.conflict_source ? `
                                            <div class="bg-light-danger p-2 rounded-3 mb-2" style="background-color: #fff5f5; border: 1px solid #fee2e2;">
                                                <h6 class="small fw-bold text-danger text-uppercase mb-1" style="font-size: 0.65rem;">Core Friction</h6>
                                                <p class="small mb-0">${edge.conflict_source}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        detailsPanel.innerHTML = `
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-cursor-fill fs-1 d-block mb-3 opacity-50"></i>
                                <h6 class="fw-bold">Select a Relationship</h6>
                                <p class="small">Click a line between characters to view details.</p>
                            </div>
                        `;
                    }
                });

                // Helper to open modal specific section
                window.openModalForEdge = function (edgeId, section) {
                    const edge = data.edges.find(e => e.id === edgeId);
                    if (edge) {
                        // Map type key
                        const type_key = edge.type_key || edge.label.toLowerCase();
                        openModal({ ...edge, type_key: type_key }, section);
                    }
                };

                // AJAX Save
                btnSave.onclick = function () {
                    const formData = {
                        id: relIdInput.value,
                        character_a: relCharA.value,
                        character_b: relCharB.value,
                        relationship_type: relType.value,
                        description: relDesc.value,
                        strength: relStrength.value,
                        trust_level: relTrust.value,
                        relationship_status: relStatus.value,
                        visibility: relVisibility.value,
                        power_dynamic: relPower.value,
                        conflict_source: relConflict.value,
                        evolution: relEvolution.value,
                        character_a_wants: relAWants.value,
                        character_b_wants: relBWants.value,
                        first_impression: relFirstImpression.value,
                        shared_secret: relSharedSecret.value,
                        vulnerability: relVulnerability.value,
                        major_shared_moments: relMoments.value,
                        predictability: relPredictability.value,
                        action: 'save'
                    };

                    btnSave.disabled = true;
                    fetch('{% url "api_manage_relationship" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(formData)
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.status === 'success') {
                                location.reload(); // Quickest way to refresh the complex map
                            } else {
                                alert("Error: " + JSON.stringify(result.errors || result.message));
                                btnSave.disabled = false;
                            }
                        })
                        .catch(e => {
                            console.error(e);
                            btnSave.disabled = false;
                        });
                };

                // AJAX Delete
                btnDelete.onclick = function () {
                    if (!confirm("Are you sure you want to remove this connection?")) return;

                    const formData = {
                        id: relIdInput.value,
                        action: 'delete'
                    };

                    fetch('{% url "api_manage_relationship" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(formData)
                    })
                        .then(response => response.json())
                        .then(result => {
                            if (result.status === 'success') {
                                location.reload();
                            }
                        });
                };
            })
            .catch(error => {
                console.error('Error fetching relationship data:', error);
                container.innerHTML = '<div class="alert alert-danger m-3">Failed to load relationship data.</div>';
            });
    });
</script>
{% endblock %}