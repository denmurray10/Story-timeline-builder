{% extends 'timeline/base.html' %}
{% load static %}

{% block title %}{{ character.name }} - Story Timeline Builder{% endblock %}

{% block extra_css %}
<style>
    .detail-card {
        background-color: #ffffff;
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-sm);
        margin-bottom: 1.5rem;
    }

    .detail-card-header {
        padding: 1rem 1.25rem;
        background: #f8fafc;
        border-bottom: 1px solid var(--border-color);
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        font-weight: 700;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .detail-card-header i {
        color: var(--accent);
    }

    .profile-avatar-box {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        border: 1px solid var(--border-color);
        object-fit: cover;
        background-color: #f8fafc;
        box-shadow: var(--shadow-sm);
    }

    .section-label {
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 4px;
    }

    .relationship-item {
        padding: 8px 12px;
        background-color: #f8fafc;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        font-size: 0.9rem;
    }

    .appearance-item {
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
    }

    .appearance-item:last-child {
        border-bottom: none;
    }

    .stat-box {
        padding: 20px;
        background-color: var(--accent-soft);
        border-radius: 12px;
        text-align: center;
        border: 1px solid rgba(99, 102, 241, 0.1);
    }

    .stat-box h3 {
        color: var(--accent);
        font-weight: 800;
        margin-bottom: 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation and Actions -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <a href="{% url 'character_list' %}" class="text-decoration-none text-muted small fw-bold">
        <i class="bi bi-chevron-left"></i> All Characters
    </a>
    <div class="btn-group">
        <a href="{% url 'character_edit' character.pk %}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-pencil me-1"></i> Edit
        </a>
        <a href="{% url 'character_delete' character.pk %}" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-trash"></i>
        </a>
    </div>
</div>

<!-- Header Info -->
<div class="detail-card p-4 mb-4">
    <div class="row align-items-center g-4">
        <div class="col-auto">
            {% if character.profile_pic_url %}
            <img src="{{ character.profile_pic_url }}" alt="{{ character.name }}" class="profile-avatar-box">
            {% else %}
            <div class="profile-avatar-box d-flex align-items-center justify-content-center text-muted">
                <i class="bi bi-person-fill fs-1"></i>
            </div>
            {% endif %}
        </div>
        <div class="col">
            <h1 class="mb-1">{{ character.name }}</h1>
            <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="badge bg-secondary">{{ character.get_role_display }}</span>
                {% if character.nickname %}
                <span class="text-muted small">"{{ character.nickname }}"</span>
                {% endif %}
                {% if not character.is_active %}
                <span class="badge bg-warning">Inactive</span>
                {% endif %}
            </div>
        </div>
        <div class="col-lg-3">
            <div class="stat-box">
                <h3>{{ events.count }}</h3>
                <p class="text-muted small mb-0 fw-bold uppercase">Appearances</p>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Main Info -->
    <div class="col-lg-8">
        <div class="detail-card">
            <div class="detail-card-header">
                <i class="bi bi-info-circle"></i> Bio & Motivation
            </div>
            <div class="p-4">
                <div class="row g-4">
                    <div class="col-md-6 border-end">
                        <div class="section-label">Description</div>
                        <p class="mb-0 small text-body">{{ character.description|default:"No description
                            provided."|linebreaks }}</p>
                    </div>
                    <div class="col-md-6">
                        <div class="section-label">Motivation</div>
                        <p class="mb-0 small text-body">{{ character.motivation|default:"No motivation
                            specified."|linebreaks }}</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="detail-card">
            <div class="detail-card-header">
                <i class="bi bi-bullseye"></i> Goals & Traits
            </div>
            <div class="p-4">
                <div class="row g-4">
                    <div class="col-md-6 border-end">
                        <div class="section-label">Goals</div>
                        <p class="mb-0 small text-body">{{ character.goals|default:"No goals specified."|linebreaks }}
                        </p>
                    </div>
                    <div class="col-md-6">
                        <div class="section-label">Personality Traits</div>
                        <p class="mb-0 small text-body">{{ character.traits|default:"No traits specified."|linebreaks }}
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div class="detail-card">
            <div class="detail-card-header justify-content-between">
                <div><i class="bi bi-diagram-3"></i> Relationships</div>
                <a href="{% url 'relationship_create' %}?from_char={{ character.pk }}"
                    class="btn btn-sm btn-link text-decoration-none py-0">Add New</a>
            </div>
            <div class="p-4">
                {% if character.relationships_from.exists or character.relationships_to.exists %}
                <div class="row g-2">
                    {% for rel in character.relationships_from.all %}
                    <div class="col-md-6">
                        <div class="relationship-item d-flex align-items-center gap-2">
                            <span class="badge bg-light text-primary border">{{ rel.relationship_type }}</span>
                            <i class="bi bi-arrow-right text-muted small"></i>
                            <a href="{% url 'character_detail' rel.to_character.pk %}"
                                class="text-decoration-none fw-bold text-dark">{{ rel.to_character.name }}</a>
                        </div>
                    </div>
                    {% endfor %}
                    {% for rel in character.relationships_to.all %}
                    <div class="col-md-6">
                        <div class="relationship-item d-flex align-items-center gap-2">
                            <a href="{% url 'character_detail' rel.from_character.pk %}"
                                class="text-decoration-none fw-bold text-dark">{{ rel.from_character.name }}</a>
                            <i class="bi bi-arrow-right text-muted small"></i>
                            <span class="badge bg-light text-muted border">{{ rel.relationship_type }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted small mb-0 italicized">No relationships recorded.</p>
                {% endif %}
            </div>
        </div>

        <div class="detail-card">
            <div class="detail-card-header">
                <i class="bi bi-clock-history"></i> Appearing in Events
            </div>
            <div class="p-0">
                {% if events %}
                {% for event in events %}
                <div class="appearance-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="overflow-hidden">
                            <h6 class="mb-1">
                                <a href="{% url 'event_detail' event.pk %}"
                                    class="text-decoration-none text-dark fw-bold">{{ event.title }}</a>
                            </h6>
                            <div class="small text-muted d-flex align-items-center gap-2">
                                <span>{{ event.book.title|default:"Main Story" }}</span>
                                {% if event.chapter %}<span class="opacity-50">|</span><span>Ch. {{
                                    event.chapter.chapter_number }}</span>{% endif %}
                            </div>
                        </div>
                        {% if event.pov_character == character %}
                        <span class="badge bg-success-subtle text-success small">POV</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="p-4 text-center text-muted small italicized">No appearances logged yet.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar Stats -->
    <div class="col-lg-4">
        <div class="detail-card">
            <div class="detail-card-header">
                <i class="bi bi-journal-check"></i> Meta Information
            </div>
            <div class="p-4 pt-1">
                <div class="mt-3">
                    <div class="section-label">Debut Book</div>
                    <div class="fw-bold">{{ character.introduction_book.title|default:"Unknown Book" }}</div>
                </div>
                <div class="mt-3">
                    <div class="section-label">Intro Chapter</div>
                    <div class="fw-bold">{{ character.introduction_chapter|default:"Unknown" }}</div>
                </div>
                <div class="mt-3">
                    <div class="section-label">Color Code</div>
                    <div class="d-flex align-items-center gap-2">
                        <div
                            style="width: 20px; height: 20px; border-radius: 4px; border: 1px solid var(--border-color); background-color: {{ character.color_code|default:'var(--accent)' }};">
                        </div>
                        <span class="small text-muted">{{ character.color_code|default:"#6366f1" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="detail-card text-center p-4 bg-light">
            <p class="text-muted small mb-3">Ask the AI Consultant for ideas on character development arcs.</p>
            <a href="{% url 'dashboard' %}" class="btn btn-sm btn-outline-primary w-100">AI Consultant</a>
        </div>
    </div>
</div>
{% endblock %}